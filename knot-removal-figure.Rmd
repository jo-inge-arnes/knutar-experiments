---
title: "R Notebook"
output: html_notebook
---

```{r}
library(ggplot2)
library(ggpubr)
library(ggh4x)
library(cladina)

f_noise <- function(xs) {
  return(rnorm(length(xs), 0, 0.2))
}

f_signal <- function(x) {
  y <- cos(pi * x)
  return(y)
}

f_x_dist  <- function(n) {
  return(rnorm(n))
}

name_and_bic <- function(name, mod) {
  k <- length(extract_knots(mod)$knots)
  return(paste(name, "~'(Knots: ", k, ", BIC: ", round(BIC(mod)), ")'", sep = ""))
}

create_figure <- function(d, mod, title) {
  fig <- ggplot(d, aes(Independent, Dependent))
  fig <- fig + theme_bw()
  fig <- fig + force_panelsizes(rows = unit(3.5, "in"), cols = unit(3.5, "in"))
  fig <- fig + geom_line(aes(y = SignalMeasured), linetype = "solid", color = "gray85", size = 1.7)
  fig <- fig + geom_point(shape = 1, color = "gray50")
  fig <- fig + geom_line(aes(y = mod$fitted.values), linetype = "solid", color = "black", size = 0.5)
  fig <- fig + ggtitle(title)
  return(fig)
}


set.seed(1)

d <- cladina::generate_data(200, 2, 2, f_x_dist, f_signal, f_noise)

res <- cladina::suggest_splines(d, Dependent, Independent, 4, all_knots = TRUE)

i_max <- length(res$all_knots)
fig_lowest_knots <- 19
knots_indices <- c(1, 10, 15, fig_lowest_knots)

figs <- lapply(knots_indices, function(i) {
  knots <- res$all_knots[[i]]
  mod <- cladina::model_by_knots(d, Dependent, Independent, 
                                 knots, res$Boundary.knots)
  return(create_figure(d, 
                mod, 
                paste("Knots: ", length(knots), ", BIC: ", round(BIC(mod), 0), sep = "")))
})

knot_removal_fig <- ggarrange(figs[[1]], figs[[2]], figs[[3]], figs[[4]], nrow = 2, ncol = 2)

ggsave("example_figs/iteratively-removing-knots.png", plot = knot_removal_fig, device = "png", dpi = "print", height = 8.4, width = 8)

k_lowest <- length(res$all_knots[[fig_lowest_knots]])
mod_standard <- cladina::model_by_count(d, Dependent, Independent, k_lowest)
fig_standard <- create_figure(d, 
                          mod_standard, 
                          paste("Knots: ", k_lowest, ", BIC: ", round(BIC(mod_standard), 0), sep = ""))

fig_standard = fig_standard + force_panelsizes(rows = unit(3.5, "in"),
                   cols = unit(3.5, "in"))


ggsave("example_figs/standard.png", plot = fig_standard, device = "png", height = 4.2, width = 4)
  
```

```{r}

knot_cnt_suggestions <- suggest_knotcount(d, Dependent, Independent, icr_fn = BIC, all_scores = TRUE)
d_knot_bics <- data.frame(
  Knots = unlist(knot_cnt_suggestions$all_scores$n_knots), BIC = unlist(knot_cnt_suggestions$all_scores$scores))


fig_bic_knot_cnts <- ggplot(d_knot_bics, aes(Knots, BIC)) + 
  theme_bw() +
  force_panelsizes(rows = unit(3.5, "in"),
                   cols = unit(7, "in")) +
  geom_point(shape = 15, color = "gray50") +
  scale_x_continuous(breaks = seq(0, 100, 20)) +
  ggtitle("BIC scores for natural spline regressions with 0 to 100 knots")
  
ggsave("example_figs/bic-and-knot-counts.png", plot = fig_bic_knot_cnts, device = "png", height = 4.2, width = 8)
```
