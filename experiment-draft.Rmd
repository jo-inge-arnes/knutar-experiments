```{r}
library(cladina)
library(dplyr)

```

```{r}

f_noise_1 <- function(xs) {
  return(rnorm(length(xs), 0, 0.1))
}

f_x_dist  <- function(n) {
  return(rlnorm(n, meanlog = 0.3, sdlog = 0.4))
}

generate_x_div_x_plus_half <- function(n) {
  d <- generate_data(n, 2, 2, f_x_dist, f_signal_x_div_half_plus_x, f_noise_1)
  return(d)
}

generate_cos <- function(n) {
  d <- generate_data(n, 2, 2, f_x_dist, f_signal_cos, f_noise_1)
  return(d)
}

f_noise_2 <- function(xs) {
  return(rnorm(xs) * xs / 10)
}

generate_mm <- function(n) {
  d <- generate_data(n, 2, 2, f_x_dist, f_signal_michaelis_menten, f_noise_1)
  return(d)
}

f_signal_parabola <- function(x) {
  return(-x^2 + x*4)
}

generate_para <- function(n) {
  d <- generate_data(n, 2, 2, f_x_dist, f_signal_parabola, f_noise_1)
}

f_signal_logistic <- function(x) {
  return(1 / (1 + exp(-(x - 1.5) / 0.2)))
}

generate_logis <- function(n) {
  d <- generate_data(n, 2, 2, f_x_dist, f_signal_logistic, f_noise_1)
}

f_signal_gompertz <- function(x) {
  return(0.25 + 0.5 * exp(-exp(-2 * (x - 1.5)))) 
}

generate_gompertz <- function(n) {
  d <- generate_data(n, 2, 2, f_x_dist, f_signal_gompertz, f_noise_1)
}

f_signal_logarithmic <- function(x) {
  return(-log((x + 1) / 10))
}

generate_logarithmic <- function(n) {
  d <- generate_data(n, 2, 2, f_x_dist, f_signal_logarithmic, f_noise_1)
}

f_signal_runge <- function(x) {
  return(1 / (1 + (x - 2)^2))
}

generate_runge <- function(n) {
  d <- generate_data(n, 2, 2, f_x_dist, f_signal_runge, f_noise_1)
}

```

```{r}

compute_rse <- function(actual, predicted, num_knots) {
  n <- length(predicted)
  
  sse <- sum((actual - predicted)**2)
  #return(sqrt(sse / (n - (num_knots + 2))))
  return(sqrt(sse / (n - 1)))
}

single_sample_experiment <- function(i, n, gen_fn, max_knots) {
  d <- gen_fn$fn(n)
  
  suggested <- suggest_knotcount(d, Dependent, Independent, max_knots, stats::BIC)
  nknots_default <-suggested$nknots
  score_default <- suggested$score
  mod_default <- model_by_count(d, Dependent, Independent, nknots_default)
  
'  
  alt_mods <- choose_splines_thorough(d, Dependent, Independent, max_nknots = max_knots, icr_fn = stats::AIC, verbose = FALSE) 
  
  mod_dist <- alt_mods$distinct$model
  mod_unif <- alt_mods$uniform$model
  mod_quant <- alt_mods$quantile$model
  
  score_dist <- alt_mods$distinct$score
  score_unif <- alt_mods$uniform$score
  score_quant <- alt_mods$quantile$score
  
  nknots_dist <- alt_mods$distinct$nknots
  nknots_unif <- alt_mods$uniform$nknots
  nknots_quant <- alt_mods$quantile$nknots
  
  mse_default <- sum((mod_default$fitted.values - d$SignalRaw)^2) / n
  mse_dist <- sum((mod_dist$fitted.values - d$SignalRaw)^2) / n
  mse_unif <- sum((mod_unif$fitted.values - d$SignalRaw)^2) / n
  mse_quant <- sum((mod_quant$fitted.values - d$SignalRaw)^2) / n

  res <- list(
    "n" = n,
    "gen_fn" = gen_fn$name,
    "score_def" = score_default, "nknots_def" = nknots_default, "mse_def" = mse_default,
    "score_dist" = score_dist, "nknots_dist" = nknots_dist, "mse_dist" = mse_dist,
    "score_unif" = score_unif, "nknots_unif" = nknots_unif, "mse_unif" = mse_unif,
    "score_quant" = score_quant, "nknots_quant" = nknots_quant, "mse_quant" = mse_quant)
'
  res_quant <- choose_splines(d, Dependent, Independent, max_nknots = max_knots, icr_fn = stats::BIC) 
  mod_quant <- res_quant$model
  nknots_quant <- length(res_quant$knots$knots)
  score_quant <- res_quant$score
  
  mse_default <- compute_rse(d$SignalMeasured, mod_default$fitted.values, nknots_default)
  mse_quant <- compute_rse(d$SignalMeasured, mod_quant$fitted.values, nknots_quant)
  
  # Create 500 evenly spaced values between lower and upper independent value
  # For computing a MSE for evenly spaced values along independent axis
  x <- data.frame(Independent = seq(from = min(d$Independent), to = max(d$Independent), length.out = 500))
  y <- unlist(lapply(x$Independent, gen_fn$curve_fn))  
  
  # Compute MSE for evenly spaced values along independent variable
  
  y_hat <- predict(mod_default, newdata = x)
  mse_def_curve <- compute_rse(y, y_hat, nknots_default)
  
  y_hat <- predict(mod_quant, newdata = x)
  mse_quant_curve <- compute_rse(y, y_hat, nknots_quant)

  
  # Return a result row as a list
  
  res <- list(
    "n" = n,
    "gen_fn" = gen_fn$name,
    "score_def" = score_default, "nknots_def" = nknots_default, "mse_def" = mse_default, "mse_def_curve" = mse_def_curve,
    "score_quant" = score_quant, "nknots_quant" = nknots_quant, "mse_quant" = mse_quant, "mse_quant_curve" = mse_quant_curve, "std_diff" = mse_default - mse_quant, "std_diff_curve" = mse_def_curve - mse_quant_curve)  
  
  R.utils::printf(".")
  
  return(res)
}

multiple_sample_experiments <- function(n, gen_fn, rep_cnt, max_knots) {
  res_list <- lapply(1:rep_cnt, single_sample_experiment, gen_fn = gen_fn, n = n, max_knots = max_knots)
  res_df <- as.data.frame(data.table::rbindlist(res_list))
  return(res_df)
}

generator_sample_experiments <- function(gen_fn, sample_sizes, samples_per_set, max_knots) {
  # Run experiments with same generator, different n, sets of many samples per n
  res_df_list <- lapply(sample_sizes, multiple_sample_experiments, gen_fn = gen_fn, rep_cnt = samples_per_set, max_knots = max_knots)
  
  res_df <- bind_rows(res_df_list, .id = "generator_sample_index")
  
  return(res_df)
}
```

```{r}
max_knots <- 4
sample_sizes <- c(200)
samples_per_set <- 200
generators <- list(
#  list("name"= "yield-loss", "fn" = generate_x_div_x_plus_half, "curve_fn" = f_signal_x_div_half_plus_x)
#  , 
#  list("name" = "logistic", "fn" = generate_logis, "curve_fn" = f_signal_logistic)
#  ,
  list("name" = "michaelis-menten", "fn" = generate_mm, "curve_fn" = f_signal_michaelis_menten)
#  ,
#  list("name" = "runge-translated", "fn" = generate_runge, "curve_fn" = f_signal_runge)
#  ,
#  list("name" = "trigonometric", "fn" = generate_cos, "curve_fn" = f_signal_cos)
  )

suppressWarnings({
  res_df_list <- lapply(generators, generator_sample_experiments, sample_sizes = sample_sizes, samples_per_set = samples_per_set, max_knots = max_knots)
})

df_all_results <- bind_rows(res_df_list, .id = "generator_index")

print('finished')
```

```{r}
#saveRDS(df_all_results, file="experiment-results-13.Rda")
```

```{r}
df_means <- df_all_results %>%
  group_by(generator_index, generator_sample_index) %>%
  summarise_at(vars(mse_def, mse_def_curve, mse_quant, mse_quant_curve, score_def, score_quant, n), list(mean = mean, sd = sd))

alpha = 0.05

df_means <- df_means %>% 
  mutate(mse_def_sde = mse_def_sd / sqrt(n_mean)) %>%
  mutate(mse_quant_sde = mse_quant_sd / sqrt(n_mean)) %>%
  mutate(mse_def_curve_sde = mse_def_curve_sd / sqrt(n_mean)) %>%
  mutate(mse_quant_curve_sde = mse_quant_curve_sd / sqrt(n_mean)) %>%
  mutate(score_def_sde = score_def_sd / sqrt(n_mean)) %>%           
  mutate(score_quant_sde = score_quant_sd / sqrt(n_mean)) %>%
  mutate(mse_def_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * mse_def_sde) %>%
  mutate(mse_quant_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * mse_quant_sde) %>%
  mutate(mse_def_curve_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * mse_def_curve_sde) %>%
  mutate(mse_quant_curve_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * mse_quant_curve_sde) %>%
  mutate(score_def_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * score_def_sde) %>%
  mutate(score_quant_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * score_quant_sde)
  
df_means <- df_means %>% 
  mutate(mse_def_lower = mse_def_mean - mse_def_conf) %>%
  mutate(mse_def_upper = mse_def_mean + mse_def_conf) %>%
  mutate(mse_quant_lower = mse_quant_mean - mse_quant_conf) %>%
  mutate(mse_quant_upper = mse_quant_mean + mse_quant_conf) %>%
  mutate(mse_def_curve_lower = mse_def_curve_mean - mse_def_curve_conf) %>%
  mutate(mse_def_curve_upper = mse_def_curve_mean + mse_def_curve_conf) %>%
  mutate(mse_quant_curve_lower = mse_quant_curve_mean - mse_quant_curve_conf) %>%
  mutate(mse_quant_curve_upper = mse_quant_curve_mean + mse_quant_curve_conf) %>%
  mutate(score_def_lower = score_def_mean - score_def_conf) %>%
  mutate(score_def_upper = score_def_mean + score_def_conf) %>%
  mutate(score_quant_lower = score_quant_mean - score_quant_conf) %>%
  mutate(score_quant_upper = score_quant_mean + score_quant_conf)

```

```{r}
library(ggplot2)

df_1 <- df_all_results[df_all_results$generator_index == 1 & df_all_results$generator_sample_index == 1, ]
'
df_2 <- df_all_results[df_all_results$generator_index == 2 & df_all_results$generator_sample_index == 1, ]

df_3 <- df_all_results[df_all_results$generator_index == 3 & df_all_results$generator_sample_index == 1, ]

df_4 <- df_all_results[df_all_results$generator_index == 4 & df_all_results$generator_sample_index == 1, ]

df_5 <- df_all_results[df_all_results$generator_index == 5 & df_all_results$generator_sample_index == 1, ]
'

hist(df_1$score_def)
hist(df_1$score_quant)

'
hist(df_2$score_def)
hist(df_2$score_quant)

hist(df_3$score_def)
hist(df_3$score_quant)

hist(df_4$score_def)
hist(df_4$score_quant)

hist(df_5$score_def)
hist(df_5$score_quant)
'

hist(df_1$mse_def)
hist(df_1$mse_quant)

'
hist(df_2$mse_def)
hist(df_2$mse_quant)

hist(df_3$mse_def)
hist(df_3$mse_quant)

hist(df_4$mse_def)
hist(df_4$mse_quant)

hist(df_5$mse_def)
hist(df_5$mse_quant)
'

hist(df_1$mse_def_curve)
hist(df_1$mse_quant_curve)

'
hist(df_2$mse_def_curve)
hist(df_2$mse_quant_curve)

hist(df_3$mse_def_curve)
hist(df_3$mse_quant_curve)

hist(df_4$mse_def_curve)
hist(df_4$mse_quant_curve)

hist(df_5$mse_def_curve)
hist(df_5$mse_quant_curve)
'

```

```{r}
hist(df_1$std_diff)
hist(df_1$std_diff_curve)

print(mean(df_1$std_diff))
print(mean(df_1$std_diff_curve))

library(boot)

b1 <- boot(df_1$std_diff, function(u,i) mean(u[i]), R = 1000)
boot.ci(b1, type = c("norm","basic","perc"))

b1 <- boot(df_1$std_diff_curve, function(u,i) mean(u[i]), R = 1000)
boot.ci(b1, type = c("norm","basic","perc"))

```

```{r}
t.test(df_1$score_def, df_1$score_quant, paired = TRUE, alternative = "two.sided")
```

```{r}
df_1$bic_diff_cats <- cut(df_1$score_def - df_1$score_quant, c(-Inf, -1, 1, Inf), c("W", "E", "B"), right = FALSE) 

ggplot(df_1, aes(x=bic_diff_cats)) + geom_bar()
```

```{r}
cor(df_1$score_def - df_1$score_quant, df_1$std_diff)
cor(df_1$score_def - df_1$score_quant, df_1$std_diff_curve)

ggplot(df_1, aes(score_def - score_quant, std_diff)) + geom_point()
ggplot(df_1, aes(score_def - score_quant, std_diff_curve)) + geom_point()

```
