```{r}
library(cladina)
library(dplyr)

```

```{r}

f_noise_1 <- function(ys) {
  return((rnorm(length(ys)) / 10) * ys)
}

f_x_dist  <- function(n) {
  return(rlnorm(n, mean = 0, sd = 0.5))
}

generate_x_div_x_plus_half <- function(n) {
  d <- generate_data(n, 2, 2, f_x_dist, f_signal_x_div_half_plus_x, f_noise_1)
  return(d)
}

generate_cos <- function(n) {
  d <- generate_data(n, 2, 2, f_x_rnorm_dist, f_signal_cos, f_noise_rnorm_scaled)
  return(d)
}

f_noise_2 <- function(ys) {
  return(rnorm(ys) * ys / 10)
}

generate_mm <- function(n) {
  d <- generate_data(n, 1, 3, f_x_lognorm_dist, f_signal_michaelis_menten, f_noise_2)
  return(d)
}

f_signal_parabola <- function(x) {
  return(-x^2 + x*4)
}

generate_para <- function(n) {
  d <- generate_data(n, 2, 2, f_x_dist, f_signal_parabola, f_noise_1)
}

f_signal_logistic <- function(x) {
  return(1 / (1 + exp(-(x - 1.5) / 0.2)))
}

generate_logis <- function(n) {
  d <- generate_data(n, 2, 2, f_x_dist, f_signal_logistic, f_noise_1)
}
```

```{r}
single_sample_experiment <- function(i, n, gen_fn, max_knots) {
  d <- gen_fn$fn(n)
  
  suggested <- suggest_knotcount(d, Dependent, Independent, max_knots, stats::BIC)
  nknots_default <-suggested$nknots
  score_default <- suggested$score
  mod_default <- model_by_count(d, Dependent, Independent, nknots_default)
  
'  
  alt_mods <- choose_splines_thorough(d, Dependent, Independent, max_nknots = max_knots, icr_fn = stats::AIC, verbose = FALSE) 
  
  mod_dist <- alt_mods$distinct$model
  mod_unif <- alt_mods$uniform$model
  mod_quant <- alt_mods$quantile$model
  
  score_dist <- alt_mods$distinct$score
  score_unif <- alt_mods$uniform$score
  score_quant <- alt_mods$quantile$score
  
  nknots_dist <- alt_mods$distinct$nknots
  nknots_unif <- alt_mods$uniform$nknots
  nknots_quant <- alt_mods$quantile$nknots
  
  mse_default <- sum((mod_default$fitted.values - d$SignalRaw)^2) / n
  mse_dist <- sum((mod_dist$fitted.values - d$SignalRaw)^2) / n
  mse_unif <- sum((mod_unif$fitted.values - d$SignalRaw)^2) / n
  mse_quant <- sum((mod_quant$fitted.values - d$SignalRaw)^2) / n

  res <- list(
    "n" = n,
    "gen_fn" = gen_fn$name,
    "score_def" = score_default, "nknots_def" = nknots_default, "mse_def" = mse_default,
    "score_dist" = score_dist, "nknots_dist" = nknots_dist, "mse_dist" = mse_dist,
    "score_unif" = score_unif, "nknots_unif" = nknots_unif, "mse_unif" = mse_unif,
    "score_quant" = score_quant, "nknots_quant" = nknots_quant, "mse_quant" = mse_quant)
'
  
  res_quant <- choose_splines(d, Dependent, Independent, max_nknots = max_knots, icr_fn = stats::BIC) 
  mod_quant <- res_quant$model
  nknots_quant <- length(res_quant$knots$knots)
  score_quant <- res_quant$score
  
  mse_default <- sum((mod_default$fitted.values - d$SignalMeasured)^2) / n
  mse_quant <- sum((mod_quant$fitted.values - d$SignalMeasured)^2) / n
  
  # Create 500 evenly spaced values between lower and upper independent value
  # For computing a MSE for evenly spaced values along independent axis
  x <- data.frame(Independent = seq(from = min(d$Independent), to = max(d$Independent), length.out = 500))
  y <- unlist(lapply(x$Independent, gen_fn$curve_fn))  
  
  # Compute MSE for evenly spaced values along independent variable
  
  y_hat <- predict(mod_default, newdata = x)
  mse_def_curve <- sum((y_hat - y)^2) / n
  
  y_hat <- predict(mod_quant, newdata = x)
  mse_quant_curve <- sum((y_hat - y)^2) / n
  
  # Return a result row as a list
  
  res <- list(
    "n" = n,
    "gen_fn" = gen_fn$name,
    "score_def" = score_default, "nknots_def" = nknots_default, "mse_def" = mse_default, "mse_def_curve" = mse_def_curve,
    "score_quant" = score_quant, "nknots_quant" = nknots_quant, "mse_quant" = mse_quant, "mse_quant_curve" = mse_quant_curve)  
  
  return(res)
}

multiple_sample_experiments <- function(n, gen_fn, rep_cnt, max_knots) {
  res_list <- lapply(1:rep_cnt, single_sample_experiment, gen_fn = gen_fn, n = n, max_knots = max_knots)
  res_df <- as.data.frame(data.table::rbindlist(res_list))
  return(res_df)
}

generator_sample_experiments <- function(gen_fn, sample_sizes, samples_per_set, max_knots) {
  # Run experiments with same generator, different n, sets of many samples per n
  res_df_list <- lapply(sample_sizes, multiple_sample_experiments, gen_fn = gen_fn, rep_cnt = samples_per_set, max_knots = max_knots)
  
  res_df <- bind_rows(res_df_list, .id = "generator_sample_index")
  
  return(res_df)
}
```

```{r}
max_knots <- 5
sample_sizes <- c(50, 125, 250)
samples_per_set <- 100
generators <- list(
  list("name"= "x_div_x", "fn" = generate_x_div_x_plus_half, "curve_fn" = f_signal_x_div_half_plus_x), 
  list("name" = "cos", "fn" = generate_cos, "curve_fn" = f_signal_cos),
  list("name" = "mm", "fn" = generate_mm, "curve_fn" = f_signal_michaelis_menten),
  list("name" = "para", "fn" = generate_para, "curve_fn" = f_signal_parabola),
  list("name" = "logis", "fn" = generate_logis, "curve_fn" = f_signal_logistic))

suppressWarnings({
  res_df_list <- lapply(generators, generator_sample_experiments, sample_sizes = sample_sizes, samples_per_set = samples_per_set, max_knots = max_knots)
})

df_all_results <- bind_rows(res_df_list, .id = "generator_index")
```

```{r}
saveRDS(df_all_results, file="experiment-results-07.Rda")
```

```{r}
df_means <- df_all_results %>%
  group_by(generator_index, generator_sample_index) %>%
  summarise_at(vars(mse_def, mse_def_curve, mse_quant, mse_quant_curve, score_def, score_quant, n), list(mean = mean, sd = sd))

alpha = 0.05

df_means <- df_means %>% 
  mutate(mse_def_sde = mse_def_sd / sqrt(n_mean)) %>%
  mutate(mse_quant_sde = mse_quant_sd / sqrt(n_mean)) %>%
  mutate(mse_def_curve_sde = mse_def_curve_sd / sqrt(n_mean)) %>%
  mutate(mse_quant_curve_sde = mse_quant_curve_sd / sqrt(n_mean)) %>%
  mutate(score_def_sde = score_def_sd / sqrt(n_mean)) %>%           
  mutate(score_quant_sde = score_quant_sd / sqrt(n_mean)) %>%
  mutate(mse_def_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * mse_def_sde) %>%
  mutate(mse_quant_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * mse_quant_sde) %>%
  mutate(mse_def_curve_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * mse_def_curve_sde) %>%
  mutate(mse_quant_curve_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * mse_quant_curve_sde) %>%
  mutate(score_def_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * score_def_sde) %>%
  mutate(score_quant_conf = qt(p = alpha / 2, df = n_mean - 1, lower.tail = FALSE) * score_quant_sde)
  
df_means <- df_means %>% 
  mutate(mse_def_lower = mse_def_mean - mse_def_conf) %>%
  mutate(mse_def_upper = mse_def_mean + mse_def_conf) %>%
  mutate(mse_quant_lower = mse_quant_mean - mse_quant_conf) %>%
  mutate(mse_quant_upper = mse_quant_mean + mse_quant_conf) %>%
  mutate(mse_def_curve_lower = mse_def_curve_mean - mse_def_curve_conf) %>%
  mutate(mse_def_curve_upper = mse_def_curve_mean + mse_def_curve_conf) %>%
  mutate(mse_quant_curve_lower = mse_quant_curve_mean - mse_quant_curve_conf) %>%
  mutate(mse_quant_curve_upper = mse_quant_curve_mean + mse_quant_curve_conf) %>%
  mutate(score_def_lower = score_def_mean - score_def_conf) %>%
  mutate(score_def_upper = score_def_mean + score_def_conf) %>%
  mutate(score_quant_lower = score_quant_mean - score_quant_conf) %>%
  mutate(score_quant_upper = score_quant_mean + score_quant_conf)

```

```{r}
library(ggplot2)

df_1 <- df_all_results[df_all_results$generator_index == 1 & df_all_results$generator_sample_index == 3, ]

df_2 <- df_all_results[df_all_results$generator_index == 2 & df_all_results$generator_sample_index == 3, ]

df_3 <- df_all_results[df_all_results$generator_index == 3 & df_all_results$generator_sample_index == 3, ]

df_4 <- df_all_results[df_all_results$generator_index == 4 & df_all_results$generator_sample_index == 3, ]

df_5 <- df_all_results[df_all_results$generator_index == 5 & df_all_results$generator_sample_index == 3, ]

hist(df_1$score_def)
hist(df_1$score_quant)

hist(df_2$score_def)
hist(df_2$score_quant)

hist(df_3$score_def)
hist(df_3$score_quant)

hist(df_4$score_def)
hist(df_4$score_quant)

hist(df_5$score_def)
hist(df_5$score_quant)

hist(df_1$mse_def)
hist(df_1$mse_quant)

hist(df_2$mse_def)
hist(df_2$mse_quant)

hist(df_3$mse_def)
hist(df_3$mse_quant)

hist(df_4$mse_def)
hist(df_4$mse_quant)

hist(df_5$mse_def)
hist(df_5$mse_quant)

hist(df_1$mse_def_curve)
hist(df_1$mse_quant_curve)

hist(df_2$mse_def_curve)
hist(df_2$mse_quant_curve)

hist(df_3$mse_def_curve)
hist(df_3$mse_quant_curve)

hist(df_4$mse_def_curve)
hist(df_4$mse_quant_curve)

hist(df_5$mse_def_curve)
hist(df_5$mse_quant_curve)
```

```{r}
print(t.test(df_1$score_def, df_1$score_quant))
print(t.test(df_2$score_def, df_2$score_quant))
print(t.test(df_3$score_def, df_3$score_quant))
print(t.test(df_4$score_def, df_4$score_quant))
print(t.test(df_5$score_def, df_5$score_quant))

print(t.test(df_1$mse_def, df_1$mse_quant))
print(t.test(df_2$mse_def, df_2$mse_quant))
print(t.test(df_3$mse_def, df_3$mse_quant))
print(t.test(df_4$mse_def, df_4$mse_quant))
print(t.test(df_5$mse_def, df_5$mse_quant))

print(t.test(df_1$mse_def_curve, df_1$mse_quant_curve))
print(t.test(df_2$mse_def_curve, df_2$mse_quant_curve))
print(t.test(df_3$mse_def_curve, df_3$mse_quant_curve))
print(t.test(df_4$mse_def_curve, df_4$mse_quant_curve))
print(t.test(df_5$mse_def_curve, df_5$mse_quant_curve))
```
